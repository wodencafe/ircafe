import org.panteleyev.jpackage.ImageType

plugins {
    id 'java'
    id 'org.springframework.boot' version '4.0.1'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'org.panteleyev.jpackageplugin' version '1.7.6'
}

group = 'cafe.woden'
version = '0.0.1-SNAPSHOT'
description = 'IRC Client in modern Java, utilizing PircBotX, Spring Boot, and RXJava.'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

springBoot {
    // Your actual GUI app entrypoint
    mainClass = 'cafe.woden.ircclient.IrcSwingApp'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter'

    // Embedded chat logging (history persistence)
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.flywaydb:flyway-core'
    runtimeOnly 'org.flywaydb:flyway-database-hsqldb'
    runtimeOnly 'org.hsqldb:hsqldb'

    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'

    implementation 'org.yaml:snakeyaml'
    implementation 'com.fasterxml.jackson.core:jackson-databind'

    implementation 'io.reactivex.rxjava3:rxjava:3.1.12'
    implementation 'com.github.pircbotx:pircbotx:2.3.1'

    implementation "io.github.andrewauclair:modern-docking-api:1.4.1"
    implementation "io.github.andrewauclair:modern-docking-single-app:1.4.1"
    implementation "io.github.andrewauclair:modern-docking-ui:1.4.1"

    implementation "com.formdev:flatlaf:3.7"
    implementation "com.formdev:flatlaf-extras:3.7"

    // Nick auto-complete (tab completion popup)
    implementation "com.fifesoft:autocomplete:3.3.3"

    implementation "org.sejda.imageio:webp-imageio:0.1.6"
    implementation "com.madgag:animated-gif-lib:1.4"

    // Layouts
    implementation "com.miglayout:miglayout-swing:11.4.2"

    implementation "org.jsoup:jsoup:1.22.1"

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
    useJUnitPlatform()
}

/**
 * ---------------------------
 * jpackage input preparation
 * ---------------------------
 *
 * We copy:
 *  - the plain jar (task 'jar' output)
 *  - runtime dependencies
 * into build/jpackage/input
 */
def jpackageInputDir = layout.buildDirectory.dir("jpackage/input")

def packagingRuntimeClasspath = configurations.findByName("productionRuntimeClasspath") ?: configurations.runtimeClasspath

tasks.register("copyJpackageDependencies", Copy) {
    from(packagingRuntimeClasspath)
    into(jpackageInputDir)
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    // Belt + suspenders: don't accidentally bundle devtools
    exclude { details ->
        details.file.name.contains("spring-boot-devtools")
    }
}

tasks.register("copyJpackageJar", Copy) {
    dependsOn tasks.named("jar")
    from(tasks.named("jar").map { it.archiveFile })
    into(jpackageInputDir)
}

tasks.named("jpackage") {
    dependsOn("build", "copyJpackageDependencies", "copyJpackageJar")
}

jpackage {
    // IMPORTANT: destination must be inside build/ (plugin deletes it before running jpackage) :contentReference[oaicite:2]{index=2}
    input = jpackageInputDir
    destination = layout.buildDirectory.dir("dist")

    appName = "IRCafe"
    vendor = "WodenCafe"
    appDescription = project.description
    appVersion = project.version.toString().replace("-SNAPSHOT", "")

    // Use the plain jar name that Gradle produced/copied
    mainJar = tasks.named("jar").get().archiveFileName.get()
    mainClass = springBoot.mainClass.get()

    type = ImageType.APP_IMAGE

    javaOptions = [
        "-Dfile.encoding=UTF-8"
    ]

    // Optional niceties per-OS
    windows {
        winConsole = false
        winMenu = true
        winShortcut = true
        winDirChooser = true
        winMenuGroup = "IRCafe"
    }

    mac {
        macPackageIdentifier = "cafe.woden.ircafe"
        macPackageName = "IRCafe"
        macAppCategory = "public.app-category.utilities"
    }

    linux {
        linuxShortcut = true
        linuxMenuGroup = "Network"
        linuxAppCategory = "Network"
    }
}
